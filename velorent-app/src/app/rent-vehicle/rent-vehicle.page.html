<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="'/vehicle/' + vehicleId"></ion-back-button>
    </ion-buttons>
    <ion-title>Rent Vehicle</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <h2>Vehicle Booking Form</h2>
  
  <!-- Rental Limit Indicator -->
  <ion-card class="rental-limit-card">
    <ion-card-content>
      <div class="rental-limit-info">
        <ion-icon name="information-circle-outline" color="primary"></ion-icon>
        <div class="limit-text">
          <span class="limit-label">Rental Usage:</span>
          <span class="limit-count">{{ userRentalCount }}/{{ maxRentals }}</span>
          <span class="limit-message" *ngIf="userRentalCount >= maxRentals" color="danger">
            (Maximum limit reached)
          </span>
        </div>
      </div>
    </ion-card-content>
  </ion-card>
  
  <form (ngSubmit)="submitBooking()" #bookingForm="ngForm">
    <!-- Step 1: User Info and Service Type -->
    <div *ngIf="step === 1">
      <ion-card>
        <ion-card-header>
          <ion-card-title class="personal-info-title">Personal Information</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item>
            <ion-label position="stacked">Full Name <span class="required">*</span></ion-label>
            <ion-input type="text" [(ngModel)]="fullName" name="fullName" required></ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="stacked">Mobile Number <span class="required">*</span></ion-label>
            <ion-input type="tel" [(ngModel)]="mobileNumber" name="mobileNumber" required maxlength="15"></ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="stacked">Service Type <span class="required">*</span></ion-label>
            <ion-input 
              type="text" 
              [(ngModel)]="serviceType" 
              name="serviceType" 
              readonly 
              placeholder="Choose one to proceed booking."
              (click)="openServiceTypeModal()">
            </ion-input>
            <!-- Debug: Show current selection -->
            <div *ngIf="serviceType" style="color: #ffd700; font-size: 0.8rem; margin-top: 4px;">
              Selected: {{ serviceType }}
            </div>
            <ion-icon name="chevron-down-outline" slot="end" (click)="openServiceTypeModal()"></ion-icon>
          </ion-item>
        </ion-card-content>
      </ion-card>
      <ion-button expand="block" color="primary" (click)="nextStep()">Next</ion-button>
    </div>

    <!-- Step 2: Booking Details -->
    <div *ngIf="step === 2">
      <ion-card *ngIf="vehicle">
        <ion-card-header>
          <ion-card-title>{{ vehicle.name }}</ion-card-title>
          <ion-card-subtitle>{{ vehicle.type }}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <div class="price">
            <ng-container *ngIf="serviceType === 'Self Drive'">
              <span>Self Drive: ‚Ç±{{ vehicle.price_without_driver | number:'1.2-2' }}/day</span>
            </ng-container>
            <ng-container *ngIf="serviceType === 'Pick-up/Drop-off'">
              <span>Pick-up/Drop-off: ‚Ç±{{ vehicle.price_with_driver | number:'1.2-2' }}/day</span>
            </ng-container>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Start Date -->
      <ion-item>
        <ion-label position="stacked">Start Date <span class="required">*</span></ion-label>
        <ion-input 
          type="date" 
          [(ngModel)]="rentFromDate" 
          name="rentFromDate" 
          [min]="minDate"
          (ionChange)="onDateChange()"
          (ionFocus)="onDateFocus()"
          [readonly]="loadingAvailability">
        </ion-input>
        <ion-icon name="calendar-outline" slot="end"></ion-icon>
      </ion-item>

      <!-- End Date -->
      <ion-item>
        <ion-label position="stacked">End Date <span class="required">*</span></ion-label>
        <ion-input 
          type="date" 
          [(ngModel)]="rentToDate" 
          name="rentToDate" 
          [min]="rentFromDate || minDate"
          (ionChange)="onDateChange()"
          (ionFocus)="onDateFocus()"
          [readonly]="loadingAvailability || !rentFromDate"
          [disabled]="!rentFromDate">
        </ion-input>
        <ion-icon name="calendar-outline" slot="end"></ion-icon>
      </ion-item>

      <!-- Number of Days Info -->
      <ion-card *ngIf="rentFromDate && rentToDate" class="days-info-card">
        <ion-card-content>
          <div class="days-info">
            <ion-icon name="calendar" color="primary"></ion-icon>
            <span>Rental Period: <strong>{{ calculateDays() }} day(s)</strong></span>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Company Availability Warning -->
      <ion-card *ngIf="rentFromDate && !companyAvailability.length" class="availability-warning-card">
        <ion-card-content>
          <div class="warning-content">
            <ion-icon name="information-circle-outline" color="warning"></ion-icon>
            <span>Please note: Operating days are Monday-Friday (10:00 AM - 04:00 PM). Saturday and Sunday are closed.</span>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Availability Status -->
      <ion-card *ngIf="rentFromDate && loadingAvailability" class="availability-loading">
        <ion-card-content>
          <div class="loading-content">
            <ion-spinner name="crescent"></ion-spinner>
            <span>Checking availability...</span>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="rentFromDate && availabilityError" class="availability-error">
        <ion-card-content>
          <div class="error-content">
            <ion-icon name="warning-outline" color="danger"></ion-icon>
            <span>{{ availabilityError }}</span>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card *ngIf="rentFromDate && selectedDateAvailability && selectedDateAvailability.isAvailable" class="availability-success">
        <ion-card-content>
          <div class="success-content">
            <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
            <span>{{ selectedDateAvailability.message }}</span>
        </div>
        </ion-card-content>
      </ion-card>

      <ion-item>
        <ion-label position="stacked">Time of Rent <span class="required">*</span></ion-label>
        <ion-select 
          [(ngModel)]="rentTime" 
          name="rentTime" 
          placeholder="Select time"
          (ionChange)="onTimeChange()"
          interface="popover"
          [disabled]="!rentFromDate">
          <ion-select-option *ngFor="let time of getAvailableTimeSlots(rentFromDate)" [value]="time">
            {{ formatTimeForDisplay(time) }}
          </ion-select-option>
        </ion-select>
      </ion-item>


      <!-- Company Availability Info -->
      <ion-card *ngIf="companyAvailability.length > 0" class="availability-info">
        <ion-card-header>
          <ion-card-title>Company Availability</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="availability-schedule">
            <div *ngFor="let day of companyAvailability" class="day-availability" [class.available]="day.isAvailable" [class.unavailable]="!day.isAvailable">
              <div class="day-name">{{ day.dayOfWeek | titlecase }}</div>
              <div class="day-status">
                <ion-icon [name]="day.isAvailable ? 'checkmark-circle' : 'close-circle'" [color]="day.isAvailable ? 'success' : 'danger'"></ion-icon>
                <span *ngIf="day.isAvailable && !day.is24Hours">{{ formatTimeForDisplay(day.startTime) }} - {{ formatTimeForDisplay(day.endTime) }}</span>
                <span *ngIf="day.isAvailable && day.is24Hours">24 Hours</span>
                <span *ngIf="!day.isAvailable">Closed</span>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Driver Selection (only for Pick-up/Drop-off service) -->
      <ion-card *ngIf="serviceType === 'Pick-up/Drop-off'">
        <ion-card-header>
          <ion-card-title>Choose Your Driver</ion-card-title>
          <ion-card-subtitle>Select a professional driver for your journey</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <!-- Loading state -->
          <div *ngIf="loadingDrivers" class="loading-container">
            <ion-spinner name="crescent"></ion-spinner>
            <p>Loading available drivers...</p>
          </div>

          <!-- Error state -->
          <div *ngIf="driversError" class="error-message">
            <ion-icon name="warning-outline" color="danger"></ion-icon>
            <span>{{ driversError }}</span>
          </div>

          <!-- No drivers available -->
          <div *ngIf="!loadingDrivers && !driversError && drivers.length === 0" class="no-drivers">
            <ion-icon name="person-outline"></ion-icon>
            <h3>No Drivers Available</h3>
            <p>Sorry, there are no drivers available for this company at the moment.</p>
          </div>

          <!-- Driver selection -->
          <div *ngIf="!loadingDrivers && !driversError && drivers.length > 0" class="drivers-list">
            <div 
              *ngFor="let driver of drivers" 
              class="driver-option"
              [class.selected]="selectedDriver?.id === driver.id"
              (click)="selectedDriver = driver">
              <div class="driver-info">
                <div class="driver-name">{{ driver.fullName }}</div>
                <div class="driver-details">
                  <div class="driver-experience">
                    <ion-icon name="star-outline"></ion-icon>
                    <span>{{ driver.experience }}</span>
                  </div>
                  <div class="driver-phone">
                    <ion-icon name="call-outline"></ion-icon>
                    <span>{{ driver.phone }}</span>
                  </div>
                </div>
              </div>
              <div class="driver-selection" *ngIf="selectedDriver?.id === driver.id">
                <ion-icon name="checkmark-circle" color="success"></ion-icon>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-item>
        <ion-label position="stacked">Location <span class="required">*</span></ion-label>
        <ion-input type="text" [(ngModel)]="destination" name="destination" required></ion-input>
      </ion-item>
      <ion-item>
        <ion-label position="stacked">Occasion</ion-label>
        <ion-input type="text" [(ngModel)]="occasion" name="occasion"></ion-input>
      </ion-item>
      <ion-item>
        <ion-label position="stacked">Message</ion-label>
        <ion-textarea [(ngModel)]="message" name="message"></ion-textarea>
      </ion-item>

      <!-- Payment Method Selection -->
      <ion-item *ngIf="totalCost > 0">
        <ion-label position="stacked">Payment Method for Down Payment <span class="required">*</span></ion-label>
        <ion-select [(ngModel)]="paymentMethod" name="paymentMethod" placeholder="Select payment method" required>
          <ion-select-option *ngFor="let method of paymentMethods" [value]="method">
            {{ method }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <!-- Future Payment Methods Notice -->
      <ion-card *ngIf="totalCost > 0" class="payment-notice-card">
        <ion-card-content>
          <div class="payment-notice">
            <ion-icon name="information-circle-outline" color="primary"></ion-icon>
            <div class="notice-content">
              <h4>Payment Methods</h4>
              <p>Currently, we only accept <strong>GCash</strong> for down payments. More payment options (Cash, Credit Card, PayMaya, Bank Transfer) will be available soon!</p>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Conditional ID Uploads -->
      <ion-item lines="none" *ngIf="serviceType === 'Self Drive'">
        <ion-label position="stacked">Valid ID (Driver's License) <span class="required">*</span></ion-label>
        <input type="file" accept="image/*" (change)="onFileChange($event, 'valid')" required />
      </ion-item>

      <div *ngIf="validIdPreview && serviceType === 'Self Drive'" class="image-preview">
        <img [src]="validIdPreview" alt="Valid ID Preview" />
      </div>

      <ion-item lines="none" *ngIf="serviceType === 'Pick-up/Drop-off'">
        <ion-label position="stacked">Valid ID (Driver's License or Other)</ion-label>
        <input type="file" accept="image/*" (change)="onFileChange($event, 'valid')" />
      </ion-item>
      <div *ngIf="validIdPreview && serviceType === 'Pick-up/Drop-off'" class="image-preview">
        <img [src]="validIdPreview" alt="Valid ID Preview" />
      </div>

      <ion-item lines="none">
        <ion-label position="stacked">Additional Valid ID (Government-issued) <span class="required">*</span></ion-label>
        <input type="file" accept="image/*" (change)="onFileChange($event, 'additional')" required />
      </ion-item>
      <div *ngIf="additionalIdPreview" class="image-preview">
        <img [src]="additionalIdPreview" alt="Additional ID Preview" />
      </div>

      <!-- Cost Summary -->
      <ion-card *ngIf="totalCost > 0" class="cost-breakdown">
        <ion-card-header>
          <ion-card-title>Cost Summary</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="cost-item">
            <span>Total Cost:</span>
            <span class="amount">‚Ç±{{ totalCost | number:'1.2-2' }}</span>
          </div>
          <div class="cost-item down-payment">
            <span>Down Payment (50%):</span>
            <span class="amount">‚Ç±{{ downPayment | number:'1.2-2' }}</span>
          </div>
          <div class="cost-item remaining">
            <span>Remaining Amount:</span>
            <span class="amount">‚Ç±{{ remainingAmount | number:'1.2-2' }}</span>
          </div>
          <div class="payment-note">
            <ion-icon name="information-circle-outline"></ion-icon>
            <span>You need to pay the down payment to confirm your booking. The remaining amount will be paid upon vehicle pickup.</span>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-button expand="block" color="medium" (click)="prevStep()">Back</ion-button>
      <ion-button expand="block" type="submit" color="primary"
        [disabled]="!rentFromDate || !rentToDate || !rentTime || !destination || (serviceType === 'Self Drive' && !validIdFile) || !additionalIdFile || (serviceType === 'Pick-up/Drop-off' && !selectedDriver) || userRentalCount >= maxRentals">
        Submit Booking
      </ion-button>
    </div>
  </form>
</ion-content>

<!-- Service Type Selection Modal -->
<ion-modal [isOpen]="showServiceTypeModal" [backdropDismiss]="false">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Select Service Type</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeServiceTypeModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="service-modal-content">
      <!-- Debug: Show current selection -->
      <div *ngIf="serviceType" style="color: #ffd700; font-size: 0.8rem; margin-bottom: 10px; text-align: center;">
        Current Selection: {{ serviceType }}
      </div>
      <!-- Debug: Show service options count -->
      <div style="color: #ffd700; font-size: 0.8rem; margin-bottom: 10px; text-align: center;">
        Options available: {{ serviceOptions.length }}
      </div>
      <div class="service-options">
        <!-- Debug: Test if ngFor is working -->
        <div style="color: #ffd700; font-size: 0.8rem; margin-bottom: 10px; text-align: center;">
          Testing: {{ serviceOptions[0] }} | {{ serviceOptions[1] }}
        </div>
        <div 
          class="service-option" 
          *ngFor="let option of serviceOptions" 
          [class.selected]="serviceType === option"
          (click)="selectServiceType(option)">
          <div class="service-icon">
            <ion-icon [name]="option === 'Self Drive' ? 'car-outline' : 'location-outline'"></ion-icon>
          </div>
          <div class="service-info">
            <h3>{{ option }}</h3>
            <p *ngIf="option === 'Self Drive'">Drive the vehicle yourself</p>
            <p *ngIf="option === 'Pick-up/Drop-off'">We'll pick you up and drop you off</p>
          </div>
          <div class="service-check" *ngIf="serviceType === option">
            <ion-icon name="checkmark-circle"></ion-icon>
          </div>
        </div>
      </div>
    </ion-content>
    <ion-footer>
      <ion-toolbar>
        <ion-button expand="block" color="primary" (click)="confirmServiceType()" [disabled]="!serviceType">
          Confirm Selection
        </ion-button>
      </ion-toolbar>
    </ion-footer>
  </ng-template>
</ion-modal>

<!-- Company Rules Modal -->
<ion-modal [isOpen]="showCompanyRulesModal" [backdropDismiss]="false" data-modal="company-rules">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Company Rules & Policies</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeCompanyRulesModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="company-rules-content">
      <div *ngIf="loadingRules" class="loading-container">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Loading company rules...</p>
      </div>
      
      <div *ngIf="!loadingRules && companyRules.length === 0" class="no-rules">
        <ion-icon name="information-circle-outline"></ion-icon>
        <h3>No Rules Available</h3>
        <p>This company has not set any specific rules or policies.</p>
      </div>

      <div *ngIf="!loadingRules && companyRules.length > 0" class="rules-container">
        <div class="rules-header">
          <ion-icon name="document-text-outline"></ion-icon>
          <h2>Important Rules & Policies</h2>
          <p>Please read and understand these rules before proceeding with your booking.</p>
        </div>
        
        <div class="rules-list">
          <div *ngFor="let rule of companyRules" class="rule-item">
            <div class="rule-header">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              <h3>{{ rule.title }}</h3>
            </div>
            <div class="rule-content">
              <p>{{ rule.content }}</p>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
    <ion-footer *ngIf="!loadingRules">
      <ion-toolbar>
        <ion-button expand="block" color="primary" (click)="acceptCompanyRules()">
          <ion-icon name="checkmark-circle" slot="start"></ion-icon>
          I Understand & Accept
        </ion-button>
      </ion-toolbar>
    </ion-footer>
  </ng-template>
</ion-modal>

<!-- Login Required Modal -->
<ion-modal [isOpen]="showLoginModal" [backdropDismiss]="false">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Login Required</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeLoginModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding login-modal-content">
      <div class="login-prompt">
        <ion-icon name="log-in-outline" color="primary" size="large"></ion-icon>
        <h2>Create an Account to Rent</h2>
        <p>You need to be logged in to submit a rental request. Please create an account or login to continue.</p>
        
        <ion-button expand="block" color="primary" (click)="goToLogin()">
          <ion-icon name="log-in" slot="start"></ion-icon>
          Log In
        </ion-button>
        
        <ion-button expand="block" color="secondary" fill="outline" (click)="goToRegister()">
          <ion-icon name="person-add" slot="start"></ion-icon>
          Create Account
        </ion-button>
        
        <ion-button expand="block" fill="clear" (click)="closeLoginModal()">
          Continue Browsing
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Terms and Conditions Modal -->
<ion-modal [isOpen]="showTermsModal" [backdropDismiss]="false">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Rental Terms & Conditions</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding" #termsContent>
      <div class="terms-content">
        <h2>Important Rental Information</h2>
        
        <h3>üìã Rental Requirements</h3>
        <ul>
          <li>Valid government-issued ID (Driver's License for Self Drive)</li>
          <li>Additional government-issued ID required</li>
          <li>Minimum age: 21 years old for Self Drive</li>
          <li>Valid credit card for security deposit</li>
        </ul>

        <h3>‚õΩ Gasoline Policy</h3>
        <ul>
          <li><strong>Gasoline Penalty:</strong> ‚Ç±500 per 1/4 tank below return level</li>
          <li>Vehicle must be returned with the same fuel level as received</li>
          <li>Fuel gauge will be documented at pickup and return</li>
          <li>Additional charges apply for fuel below specified level</li>
        </ul>

        <h3>üöó Damage & Insurance</h3>
        <ul>
          <li><strong>Damage Fee:</strong> ‚Ç±2,000 - ‚Ç±10,000 depending on damage severity</li>
          <li>Comprehensive insurance coverage included</li>
          <li>Deductible applies for damage claims</li>
          <li>Pre-rental inspection required</li>
          <li>Photos will be taken before and after rental</li>
        </ul>

        <h3>üí∞ Additional Charges</h3>
        <ul>
          <li><strong>Late Return:</strong> ‚Ç±500 per hour after scheduled return time</li>
          <li><strong>Cleaning Fee:</strong> ‚Ç±300 for excessive dirt/stains</li>
          <li><strong>Smoking Fee:</strong> ‚Ç±500 if smoking detected</li>
          <li><strong>Pet Fee:</strong> ‚Ç±200 if pets transported</li>
          <li><strong>Traffic Violations:</strong> Customer responsible for all fines</li>
        </ul>

        <h3>üì± Cancellation Policy</h3>
        <ul>
          <li>Free cancellation up to 24 hours before rental</li>
          <li>50% charge for cancellation within 24 hours</li>
          <li>No refund for same-day cancellations</li>
        </ul>

        <h3>‚ö†Ô∏è Important Reminders</h3>
        <ul>
          <li>Inspect vehicle thoroughly before departure</li>
          <li>Report any damage immediately</li>
          <li>Keep emergency contact numbers handy</li>
          <li>Follow traffic rules and speed limits</li>
          <li>Return vehicle on time to avoid late fees</li>
        </ul>

        <h3>üìû Contact Information</h3>
        <p>For emergencies or questions:</p>
        <ul>
          <li>Emergency: +63 931 728 7592</li>
          <li>Support: support&#64;velorent.com</li>
          <li>Office Hours: 8:00 AM - 8:00 PM</li>
        </ul>

        <!-- Remove scroll-indicator -->
      </div>
    </ion-content>
    <ion-footer>
      <ion-toolbar>
        <ion-button expand="block" color="primary" (click)="closeTermsModal()" [disabled]="!hasScrolledToBottom">
          <ion-icon *ngIf="hasScrolledToBottom" name="checkmark-outline" slot="start"></ion-icon>
          {{ hasScrolledToBottom ? 'I Agree to Terms & Conditions' : 'Please scroll down to the bottom to continue' }}
        </ion-button>
      </ion-toolbar>
    </ion-footer>
  </ng-template>
</ion-modal> 