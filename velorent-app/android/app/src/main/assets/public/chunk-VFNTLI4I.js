import{a as U}from"./chunk-LCH4KXAK.js";import"./chunk-NUHOWZQU.js";import{$ as w,A as f,Eb as v,H as h,O as p,Sb as O,k as u,t as c,ua as b,y as d,z as m}from"./chunk-2AVOPVJ6.js";import"./chunk-6TEYLYMN.js";import"./chunk-QUJFQN2Y.js";import"./chunk-MQ34CZDB.js";import"./chunk-3HFMG4JC.js";import"./chunk-GNKKXBWB.js";import"./chunk-ALHFSM7F.js";import"./chunk-6EIW3MWH.js";import"./chunk-V2LICYYN.js";import"./chunk-J3KPDA35.js";import"./chunk-HQYYVS42.js";import"./chunk-E6DTWWEQ.js";import"./chunk-SYUL6SJY.js";import"./chunk-RFVCZTOC.js";import"./chunk-DI7UCLSP.js";import"./chunk-3IVKBF6N.js";import"./chunk-FXFZIWDD.js";import"./chunk-BGL2RXYC.js";import"./chunk-42C7ZIID.js";import"./chunk-C5RQ2IC2.js";import"./chunk-4FNGVWOR.js";import"./chunk-F7H4DQG2.js";import"./chunk-LBMIQEU6.js";import"./chunk-WI5MSH4N.js";import"./chunk-EGZPES6R.js";import"./chunk-CKP3SGE2.js";import"./chunk-BGDP6BPN.js";import{a as g,g as l}from"./chunk-2K7NMRC4.js";var C=(()=>{let r=class r{constructor(e,o){this.route=e,this.oauthCallbackService=o}ngOnInit(){this.route.queryParams.subscribe(e=>{let o=this.parseHashParams(window.location.hash),t=e.code||o.code,n=e.id_token||o.id_token,i=e.error||o.error,s=e.state||o.state;console.log("Google callback params:",e),i?(console.error("Google OAuth error:",i),this.sendMessageToParent("GOOGLE_AUTH_ERROR",{error:i})):t&&s==="google_auth"?(console.log("Google OAuth code received:",t),this.exchangeCodeForUserInfo(t,n)):(console.log("No code or invalid state received"),this.sendMessageToParent("GOOGLE_AUTH_ERROR",{error:"No authorization code received"}))})}parseHashParams(e){return!e||e.length<=1?{}:(e.startsWith("#")?e.substring(1):e).split("&").reduce((t,n)=>{let[i,s]=n.split("=");return i&&(t[decodeURIComponent(i)]=s?decodeURIComponent(s):""),t},{})}exchangeCodeForUserInfo(e,o){return l(this,null,function*(){try{console.log("Exchanging Google OAuth code for user info:",e);let t=this.buildUserFromIdToken(o)||(yield this.getUserInfoFromCode(e));console.log("User info retrieved:",t),yield this.oauthCallbackService.handleOAuthCallback(t),console.log("OAuth callback handled successfully with backend"),this.sendMessageToParent("GOOGLE_AUTH_SUCCESS",{user:t});let n=this.getReturnUrl();console.log("Redirecting to:",n),window.location.href=n}catch(t){console.error("Error in exchangeCodeForUserInfo:",t);let n=t instanceof Error?t.message:"Unknown error occurred";this.sendMessageToParent("GOOGLE_AUTH_ERROR",{error:n}),setTimeout(()=>{window.location.href="/login?error="+encodeURIComponent(n)},300)}})}getReturnUrl(){let e=localStorage.getItem("returnUrl")||"/dashboard";return localStorage.removeItem("returnUrl"),e}showSuccessMessage(){document.body.innerHTML=`
      <div style="
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e, #0f3460);
        color: #ffd700;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        text-align: center;
        padding: 20px;
      ">
        <div style="
          background: rgba(24, 24, 24, 0.95);
          padding: 2rem;
          border-radius: 20px;
          border: 2px solid #ffd700;
          max-width: 400px;
          box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
        ">
          <div style="font-size: 3rem; margin-bottom: 1rem;">\u2705</div>
          <h2 style="color: #ffd700; margin-bottom: 1rem;">Login Successful!</h2>
          <p style="color: #e0e0e0; margin-bottom: 1.5rem;">This window will close automatically in <span id="countdown">2</span> seconds...</p>
          <p style="color: #b0b0b0; font-size: 0.9rem;">You will be redirected to the main page.</p>
        </div>
      </div>
    `;let e=2,o=document.getElementById("countdown"),t=setInterval(()=>{e--,o&&(o.textContent=e.toString()),e<=0&&clearInterval(t)},1e3)}buildUserFromIdToken(e){if(!e)return null;try{let o=JSON.parse(atob(e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"))),t=sessionStorage.getItem("google_oauth_nonce");return o.nonce&&t&&o.nonce!==t?(console.warn("Nonce mismatch; ignoring id_token"),null):{id:o.sub||"google_user_"+Date.now(),email:o.email||"",name:o.name||o.email||"Google User",picture:o.picture||"",provider:"google",created_at:new Date().toISOString()}}catch(o){return console.error("Failed to parse id_token",o),null}}getUserInfoFromCode(e){return l(this,null,function*(){return{id:"google_user_"+Date.now(),email:"",name:"Google User",picture:"",provider:"google",created_at:new Date().toISOString()}})}sendMessageToParent(e,o){console.log("Sending message to parent:",{type:e,data:o}),window.googleAuthResolve&&window.googleAuthReject?e==="GOOGLE_AUTH_SUCCESS"?(console.log("Resolving Google auth with user data"),window.googleAuthResolve(o.user)):e==="GOOGLE_AUTH_ERROR"&&(console.log("Rejecting Google auth with error"),window.googleAuthReject(new Error(o.error))):window.opener?(window.opener.postMessage(g({type:e},o),window.location.origin),console.log("Message sent to parent window")):console.log("No parent window or stored auth functions; continuing without postMessage")}};r.\u0275fac=function(o){return new(o||r)(c(b),c(U))},r.\u0275cmp=u({type:r,selectors:[["app-google-callback"]],standalone:!0,features:[p],decls:5,vars:0,consts:[[1,"callback-container"],[1,"callback-content"],["name","crescent"]],template:function(o,t){o&1&&(d(0,"div",0)(1,"div",1),f(2,"ion-spinner",2),d(3,"p"),h(4,"Processing Google authentication..."),m()()())},dependencies:[w,O,v],styles:[".callback-container[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;height:100vh;background:linear-gradient(135deg,#0f0f23,#1a1a2e,#16213e,#0f3460)}.callback-content[_ngcontent-%COMP%]{text-align:center;color:gold}ion-spinner[_ngcontent-%COMP%]{margin-bottom:1rem}"]});let a=r;return a})();export{C as GoogleCallbackComponent};
